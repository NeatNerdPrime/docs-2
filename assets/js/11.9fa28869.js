(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{181:function(s,t,a){"use strict";a.r(t);var n=a(0),e=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"content"},[a("h1",{attrs:{id:"deploying-pixelfed-on-arch-linux"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deploying-pixelfed-on-arch-linux","aria-hidden":"true"}},[s._v("#")]),s._v(" Deploying Pixelfed on Arch Linux")]),s._v(" "),a("h2",{attrs:{id:"assumptions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#assumptions","aria-hidden":"true"}},[s._v("#")]),s._v(" Assumptions")]),s._v(" "),a("p",[s._v("These instructions will install Pixelfed with the following:")]),s._v(" "),a("ul",[a("li",[s._v("Nginx (instead of Apache)")]),s._v(" "),a("li",[s._v("MariaDB (instead of PostgreSQL)")]),s._v(" "),a("li",[s._v("PHP-FPM (latest version)")]),s._v(" "),a("li",[s._v("ImageMagick (instead of GD)")]),s._v(" "),a("li",[s._v("Redis and PHP-FPM running via sockets instead of TCP (same machine)")]),s._v(" "),a("li",[a("code",[s._v("pixelfed")]),s._v(" user for running Horizon queues, "),a("code",[s._v("http")]),s._v(" user for running web processes (Arch default)")]),s._v(" "),a("li",[s._v("Repo cloned at "),a("code",[s._v("/home/pixelfed")])]),s._v(" "),a("li",[s._v("No other sites/services running on this machine")])]),s._v(" "),a("h2",{attrs:{id:"preparing-a-machine"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#preparing-a-machine","aria-hidden":"true"}},[s._v("#")]),s._v(" Preparing a machine")]),s._v(" "),a("p",[s._v("You will need a machine running Arch Linux with access to the root account.")]),s._v(" "),a("ol",[a("li",[s._v("Login as "),a("code",[s._v("root")]),s._v(".")]),s._v(" "),a("li",[s._v("Create the "),a("code",[s._v("pixelfed")]),s._v(" user and group:")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("useradd")]),s._v(" -rU -s /bin/bash pixelfed\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("Install dependencies:")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("pacman -S --needed nginx mariadb redis "),a("span",{attrs:{class:"token function"}},[s._v("git")]),s._v(" php-fpm php-intl php-imagick composer jpegoptim optipng pngquant imagemagick unzip\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[s._v("Setup database. During "),a("code",[s._v("mysql_secure_installation")]),s._v(", hit Enter to use the default options. Make sure to set a password for the SQL user "),a("code",[s._v("root")]),s._v(" (as by default, there is no password).")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mysql_install_db --user"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql --basedir"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr --datadir"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/lib/mysql\nsystemctl "),a("span",{attrs:{class:"token function"}},[s._v("enable")]),s._v(" --now mariadb\nmysql_secure_installation\n")])])]),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("database")]),s._v(" pixelfed"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("grant")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("all")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("privileges")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("on")]),s._v(" pixelfed"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'pixelfed'")]),s._v("@'localhost"),a("span",{attrs:{class:"token string"}},[s._v("' identified by '")]),s._v("strong_password'"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nflush "),a("span",{attrs:{class:"token keyword"}},[s._v("privileges")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("ol",{attrs:{start:"5"}},[a("li",[s._v("Edit "),a("code",[s._v("/etc/php/php.ini")]),s._v(" and uncomment the following lines:")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("extension=bcmath\nextension=iconv\nextension=intl\nextension=mysqli\nextension=pdo_mysql\n")])])]),a("p",[s._v("Edit the following lines to your desired upload limits:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("post_max_size = 8M\nupload_max_filesize = 2M\nmax_file_uploads = 20\n")])])]),a("p",[s._v("Edit "),a("code",[s._v("/etc/php/conf.d/imagick.ini")]),s._v(" and uncomment:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("extension=imagick\n")])])]),a("ol",{attrs:{start:"6"}},[a("li",[s._v("Edit "),a("code",[s._v("/etc/redis.conf")]),s._v(" and edit the following lines:")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('port 6379                           # change this to "port 0" to disable network packets\nunixsocket /run/redis/redis.sock    # \nunixsocketperm 770                  # give permission to "redis" user and group\n')])])]),a("ol",{attrs:{start:"7"}},[a("li",[s._v("Edit "),a("code",[s._v("/etc/nginx/nginx.conf")]),s._v(":")])]),s._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[s._v("worker_processes")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("1")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{attrs:{class:"token comment"}},[s._v("# change to auto, or 1 x your CPU cores, but 1 is enough")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("events")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("worker_connections")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("1024")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{attrs:{class:"token comment"}},[s._v("# 512-1024 is fine for a small site, but you may want to use up to 10k or more, if running in production with many users")]),s._v("\n"),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("http")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{attrs:{class:"token comment"}},[s._v("# [...]")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("gzip")]),s._v(" on"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{attrs:{class:"token comment"}},[s._v("# uncomment this line")]),s._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    "),a("span",{attrs:{class:"token comment"}},[s._v("# delete this entire block")]),s._v("\n        "),a("span",{attrs:{class:"token comment"}},[s._v("# [...]")]),s._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("include")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),a("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("pixelfed"),a("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{attrs:{class:"token comment"}},[s._v("# we will make this file later")]),s._v("\n"),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("Generate SSL cert:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /etc/nginx/ssl\nopenssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/ssl/server.key -out /etc/nginx/ssl/server.crt\n")])])]),a("ol",{attrs:{start:"8"}},[a("li",[s._v("Add users to groups:")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("usermod")]),s._v(" -aG pixelfed http  "),a("span",{attrs:{class:"token comment"}},[s._v("# give web user permission to serve pixelfed")]),s._v("\n"),a("span",{attrs:{class:"token function"}},[s._v("usermod")]),s._v(" -aG redis pixelfed "),a("span",{attrs:{class:"token comment"}},[s._v("# give app user access to redis for queues")]),s._v("\n"),a("span",{attrs:{class:"token function"}},[s._v("usermod")]),s._v(" -aG redis http     "),a("span",{attrs:{class:"token comment"}},[s._v("# allow web user to proxy php-fpm to redis")]),s._v("\n")])])]),a("ol",{attrs:{start:"9"}},[a("li",[s._v("Enable services:")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("systemctl "),a("span",{attrs:{class:"token function"}},[s._v("enable")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("nginx,redis,php-fpm"),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nsystemctl start "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("redis,php-fpm"),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{attrs:{class:"token comment"}},[s._v("# nginx will fail if started now")]),s._v("\n")])])]),a("h2",{attrs:{id:"pixelfed-setup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pixelfed-setup","aria-hidden":"true"}},[s._v("#")]),s._v(" Pixelfed setup")]),s._v(" "),a("ol",[a("li",[s._v("Clone the repo:")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("cd /home\ngit clone -b dev https://github.com/pixelfed/pixelfed.git pixelfed\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("Setup environment variables and nginx:")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("cd")]),s._v(" pixelfed\n"),a("span",{attrs:{class:"token function"}},[s._v("cp")]),s._v(" contrib/nginx.conf nginx.conf\n"),a("span",{attrs:{class:"token comment"}},[s._v("# edit nginx.conf")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("## in particular, set the correct domain name")]),s._v("\nsystemctl start nginx\n"),a("span",{attrs:{class:"token function"}},[s._v("cp")]),s._v(" .env.example .env\n"),a("span",{attrs:{class:"token comment"}},[s._v("# edit .env")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("## in particular, set:")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("### REDIS_SCHEME = unix")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("### REDIS_PATH = /run/redis/redis.sock")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("### IMAGE_DRIVER = imagick")]),s._v("\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("Set permissions:")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'umask 002'")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" .bash_profile\n"),a("span",{attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R pixelfed:pixelfed "),a("span",{attrs:{class:"token keyword"}},[s._v(".")]),s._v("\n"),a("span",{attrs:{class:"token function"}},[s._v("find")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v(".")]),s._v(" -type d -exec "),a("span",{attrs:{class:"token function"}},[s._v("chmod")]),s._v(" 775 "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \\"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{attrs:{class:"token function"}},[s._v("find")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v(".")]),s._v(" -type f -exec "),a("span",{attrs:{class:"token function"}},[s._v("chmod")]),s._v(" 664 "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \\"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{attrs:{class:"token function"}},[s._v("chmod")]),s._v(" g+s "),a("span",{attrs:{class:"token keyword"}},[s._v(".")]),s._v("\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[s._v("Switch to the "),a("code",[s._v("pixelfed")]),s._v(" user:")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("su")]),s._v(" - pixelfed\n")])])]),a("ol",{attrs:{start:"5"}},[a("li",[s._v("Deploy:")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("composer "),a("span",{attrs:{class:"token function"}},[s._v("install")]),s._v(" --no-ansi --no-interaction --no-progress --no-scripts --optimize-autoloader\nphp artisan key:generate\nphp artisan storage:link\nphp artisan horizon:terminate\nphp artisan config:cache\nphp artisan route:cache\nphp artisan migrate --force\n")])])]),a("ol",{attrs:{start:"6"}},[a("li",[s._v("Start Horizon task queue:")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("php artisan horizon\n")])])])])}],!1,null,null,null);e.options.__file="arch.md";t.default=e.exports}}]);